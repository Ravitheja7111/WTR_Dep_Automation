---
 - hosts: all
   gather_facts: no
   tasks:
     - name: Create MUA backup directory
       shell: "{{ item }}"
       with_items:
            #- rm -rf /staging/deploys/Monthly_Release/MW_bkp/`date '+%Y-%m-%d'`/*.tar
            - mkdir -p /staging/deploys/Monthly_Release/MW_bkp_{{ Environment }}/`date '+%Y-%m-%d'`

     - name: Take Middleware dir backup before MUA/ORUM deployment
       shell: "{{ item }}"
       with_items:
            - tar -pcf /staging/deploys/Monthly_Release/MW_bkp_{{ Environment }}/`date '+%Y-%m-%d'`/{{ Environment }}_MW_{{ appuser }}_{{ Application }}.tar Middleware
            #- chmod -R 777 /staging/deploys/Monthly_Release/MW_bkp_{{ Environment }}/`date '+%Y-%m-%d'`/{{ Environment }}_MW_{{ appuser }}_{{ Application }}.tar
            - chmod -R 777 /staging/deploys/Monthly_Release/MW_bkp_{{ Environment }}
       async: 1800
       poll: 60
       args:
         chdir: /u01/app/{{ appuser }}/Oracle
       register: mw_bkp
     - debug: 
         var: mw_bkp.stdout_lines
   become: yes
   become_user: "{{ appuser }}"
   become_method: sudo
