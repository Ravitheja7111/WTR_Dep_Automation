---
 - hosts: all
   gather_facts: no
   tasks:
     - name: create RMS_BATCH backup directory
       shell: "{{ item }}"
       with_items:
            #- rm -rf /staging/deploys/Monthly_Release/RMS_BATCH/`date '+%Y-%m-%d'`/*.tar
            - mkdir -p /staging/deploys/Monthly_Release/RMS_BATCH/`date '+%Y-%m-%d'`
     - name: Take RMS_BATCH dir backup before RMS_BATCH execution
       shell: "{{ item }}"
       with_items:
            - tar --exclude='RMS_BATCH/JLCUSTOM' --exclude='RMS_BATCH/data/staging' --exclude='RMS_BATCH/data/RREPORT_DIR' --exclude='RMS_BATCH/data/MSUP_DIR' -pcf /staging/deploys/Monthly_Release/RMS_BATCH/`date '+%Y-%m-%d'`/{{ Environment }}_{{ Application }}.tar RMS_BATCH
            - chmod -R 777 /staging/deploys/Monthly_Release/RMS_BATCH/`date '+%Y-%m-%d'`/{{ Environment }}_{{ Application }}.tar
       args:
         chdir: /u02/app/oretail
       register: rmsbatch_bkp
     - debug: 
         var: rmsbatch_bkp.stdout_lines

   become: yes
   become_user: oretail
   become_method: sudo